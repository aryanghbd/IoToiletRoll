{"ast":null,"code":"'use strict';\n\nconst {\n  Buffer\n} = require('buffer');\n\nconst Transform = require('readable-stream').Transform;\n\nconst duplexify = require('duplexify');\n/* global wx */\n\n\nlet socketTask, proxy, stream;\n\nfunction buildProxy() {\n  const proxy = new Transform();\n\n  proxy._write = function (chunk, encoding, next) {\n    socketTask.send({\n      data: chunk.buffer,\n      success: function () {\n        next();\n      },\n      fail: function (errMsg) {\n        next(new Error(errMsg));\n      }\n    });\n  };\n\n  proxy._flush = function socketEnd(done) {\n    socketTask.close({\n      success: function () {\n        done();\n      }\n    });\n  };\n\n  return proxy;\n}\n\nfunction setDefaultOpts(opts) {\n  if (!opts.hostname) {\n    opts.hostname = 'localhost';\n  }\n\n  if (!opts.path) {\n    opts.path = '/';\n  }\n\n  if (!opts.wsOptions) {\n    opts.wsOptions = {};\n  }\n}\n\nfunction buildUrl(opts, client) {\n  const protocol = opts.protocol === 'wxs' ? 'wss' : 'ws';\n  let url = protocol + '://' + opts.hostname + opts.path;\n\n  if (opts.port && opts.port !== 80 && opts.port !== 443) {\n    url = protocol + '://' + opts.hostname + ':' + opts.port + opts.path;\n  }\n\n  if (typeof opts.transformWsUrl === 'function') {\n    url = opts.transformWsUrl(url, opts, client);\n  }\n\n  return url;\n}\n\nfunction bindEventHandler() {\n  socketTask.onOpen(function () {\n    stream.setReadable(proxy);\n    stream.setWritable(proxy);\n    stream.emit('connect');\n  });\n  socketTask.onMessage(function (res) {\n    let data = res.data;\n    if (data instanceof ArrayBuffer) data = Buffer.from(data);else data = Buffer.from(data, 'utf8');\n    proxy.push(data);\n  });\n  socketTask.onClose(function () {\n    stream.end();\n    stream.destroy();\n  });\n  socketTask.onError(function (res) {\n    stream.destroy(new Error(res.errMsg));\n  });\n}\n\nfunction buildStream(client, opts) {\n  opts.hostname = opts.hostname || opts.host;\n\n  if (!opts.hostname) {\n    throw new Error('Could not determine host. Specify host manually.');\n  }\n\n  const websocketSubProtocol = opts.protocolId === 'MQIsdp' && opts.protocolVersion === 3 ? 'mqttv3.1' : 'mqtt';\n  setDefaultOpts(opts);\n  const url = buildUrl(opts, client);\n  socketTask = wx.connectSocket({\n    url: url,\n    protocols: [websocketSubProtocol]\n  });\n  proxy = buildProxy();\n  stream = duplexify.obj();\n\n  stream._destroy = function (err, cb) {\n    socketTask.close({\n      success: function () {\n        cb && cb(err);\n      }\n    });\n  };\n\n  const destroyRef = stream.destroy;\n\n  stream.destroy = function () {\n    stream.destroy = destroyRef;\n    const self = this;\n    setTimeout(function () {\n      socketTask.close({\n        fail: function () {\n          self._destroy(new Error());\n        }\n      });\n    }, 0);\n  }.bind(stream);\n\n  bindEventHandler();\n  return stream;\n}\n\nmodule.exports = buildStream;","map":{"version":3,"sources":["/Users/hollysolomon/Documents/year3/EmbeddedSys/EmbeddedSystems22/webapp/MERN-stack-login-authentication/node_modules/mqtt/lib/connect/wx.js"],"names":["Buffer","require","Transform","duplexify","socketTask","proxy","stream","buildProxy","_write","chunk","encoding","next","send","data","buffer","success","fail","errMsg","Error","_flush","socketEnd","done","close","setDefaultOpts","opts","hostname","path","wsOptions","buildUrl","client","protocol","url","port","transformWsUrl","bindEventHandler","onOpen","setReadable","setWritable","emit","onMessage","res","ArrayBuffer","from","push","onClose","end","destroy","onError","buildStream","host","websocketSubProtocol","protocolId","protocolVersion","wx","connectSocket","protocols","obj","_destroy","err","cb","destroyRef","self","setTimeout","bind","module","exports"],"mappings":"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","sourcesContent":["'use strict'\n\nconst { Buffer } = require('buffer')\nconst Transform = require('readable-stream').Transform\nconst duplexify = require('duplexify')\n\n/* global wx */\nlet socketTask, proxy, stream\n\nfunction buildProxy () {\n  const proxy = new Transform()\n  proxy._write = function (chunk, encoding, next) {\n    socketTask.send({\n      data: chunk.buffer,\n      success: function () {\n        next()\n      },\n      fail: function (errMsg) {\n        next(new Error(errMsg))\n      }\n    })\n  }\n  proxy._flush = function socketEnd (done) {\n    socketTask.close({\n      success: function () {\n        done()\n      }\n    })\n  }\n\n  return proxy\n}\n\nfunction setDefaultOpts (opts) {\n  if (!opts.hostname) {\n    opts.hostname = 'localhost'\n  }\n  if (!opts.path) {\n    opts.path = '/'\n  }\n\n  if (!opts.wsOptions) {\n    opts.wsOptions = {}\n  }\n}\n\nfunction buildUrl (opts, client) {\n  const protocol = opts.protocol === 'wxs' ? 'wss' : 'ws'\n  let url = protocol + '://' + opts.hostname + opts.path\n  if (opts.port && opts.port !== 80 && opts.port !== 443) {\n    url = protocol + '://' + opts.hostname + ':' + opts.port + opts.path\n  }\n  if (typeof (opts.transformWsUrl) === 'function') {\n    url = opts.transformWsUrl(url, opts, client)\n  }\n  return url\n}\n\nfunction bindEventHandler () {\n  socketTask.onOpen(function () {\n    stream.setReadable(proxy)\n    stream.setWritable(proxy)\n    stream.emit('connect')\n  })\n\n  socketTask.onMessage(function (res) {\n    let data = res.data\n\n    if (data instanceof ArrayBuffer) data = Buffer.from(data)\n    else data = Buffer.from(data, 'utf8')\n    proxy.push(data)\n  })\n\n  socketTask.onClose(function () {\n    stream.end()\n    stream.destroy()\n  })\n\n  socketTask.onError(function (res) {\n    stream.destroy(new Error(res.errMsg))\n  })\n}\n\nfunction buildStream (client, opts) {\n  opts.hostname = opts.hostname || opts.host\n\n  if (!opts.hostname) {\n    throw new Error('Could not determine host. Specify host manually.')\n  }\n\n  const websocketSubProtocol =\n    (opts.protocolId === 'MQIsdp') && (opts.protocolVersion === 3)\n      ? 'mqttv3.1'\n      : 'mqtt'\n\n  setDefaultOpts(opts)\n\n  const url = buildUrl(opts, client)\n  socketTask = wx.connectSocket({\n    url: url,\n    protocols: [websocketSubProtocol]\n  })\n\n  proxy = buildProxy()\n  stream = duplexify.obj()\n  stream._destroy = function (err, cb) {\n    socketTask.close({\n      success: function () {\n        cb && cb(err)\n      }\n    })\n  }\n\n  const destroyRef = stream.destroy\n  stream.destroy = function () {\n    stream.destroy = destroyRef\n\n    const self = this\n    setTimeout(function () {\n      socketTask.close({\n        fail: function () {\n          self._destroy(new Error())\n        }\n      })\n    }, 0)\n  }.bind(stream)\n\n  bindEventHandler()\n\n  return stream\n}\n\nmodule.exports = buildStream\n"]},"metadata":{},"sourceType":"script"}